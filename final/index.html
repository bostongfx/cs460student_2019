<!DOCTYPE html>
<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <link rel="shortcut icon" href="gfx/cs460.png" type="image/gif">
    <link rel="stylesheet" href="styles.css">

    <title>CS460 Final</title>
    <script src="https://threejs.org/examples/js/libs/dat.gui.min.js" type="text/javascript"></script>
    <script src="opencv.js" async onload="onOpenCvReady()"></script>

</head>

<body>
    <header>
      <h1>opencv image processing</h1>
      <div id="logo"><img style="height:60px" src="gfx/cs460.png"></div>
    </header>

    <input type='file' id='fileInput' accept='image/*'/>

  <div style="margin-bottom:30px;">
    <table id="imageTable" width="80%" cellspacing="0" cellpadding="0" border="0">
    <tbody>
      <tr>
        <td>
              <img id='srcImage'></img>
        </td>
        <td>
              <canvas id='outputCanvas'></canvas>
        </td>
    </tr>
    <tr>
      <td>
        <button type="button" id="addBtn" onclick="addTransformation()">New</button>
      </td>
      <td id="srcErr"></td>
    </tr>
    </tbody>
  </table>
</div>

  </body>
  <script type="text/javascript">
      let imgElement = document.getElementById('srcImage');
      let inputElement = document.getElementById('fileInput');
      inputElement.addEventListener("change", (e) => {
          imgElement.src = URL.createObjectURL(e.target.files[0]);
      }, false);
      imgElement.onload = function() {
          let mat = cv.imread(imgElement);
          cv.imshow('outputCanvas', mat);
          mat.delete();
      }
      gray = false;

      controller = {
          "Gray": function(){
            gray = true;
            if (isCanvasBlank(document.getElementById('outputCanvas'))) {
              let mat = cv.imread(imgElement);
              cv.cvtColor(mat, mat, cv.COLOR_RGBA2GRAY);
              cv.imshow('outputCanvas', mat);
              mat.delete();
            }
            else {
              let mat = cv.imread(document.getElementById('outputCanvas'));
              cv.cvtColor(mat, mat, cv.COLOR_RGBA2GRAY);
              cv.imshow('outputCanvas', mat);
              mat.delete();
            }
          }
      }

      var BinaryThresh = function() {
        this.thresh =  127;
        this.alpha =  127;
      };

      var gui = new dat.GUI();
      gui.domElement.id = 'gui';
      var colors = gui.addFolder( "Colors" );
      colors.add( controller, 'Gray' );
      colors.open();
      var b_threshold = gui.addFolder("Binary Threshold");
      var bin = new BinaryThresh();
      b_threshold.add(bin, 'thresh', 0, 255).onChange( function(val) {
          let mat = cv.imread(imgElement);
          if (gray) {
            cv.cvtColor(mat, mat, cv.COLOR_RGBA2GRAY, 0);
          }
          cv.threshold(mat, mat, val, bin.alpha, cv.THRESH_BINARY);
          cv.imshow('outputCanvas', mat);
          mat.delete();
      }); // Min and max
      b_threshold.add(bin, 'alpha', 0, 255).onChange( function(val) {
          let mat = cv.imread(imgElement);
          if (gray) {
            cv.cvtColor(mat, mat, cv.COLOR_RGBA2GRAY, 0);
          }
          cv.threshold(mat, mat, bin.thresh, val, cv.THRESH_BINARY);
          cv.imshow('outputCanvas', mat);
          mat.delete();
      }); // Min and max

      b_threshold.open();

      function onOpenCvReady() {
          console.log( 'OpenCV Ready', cv);

          let imgElement = document.getElementById('srcImage')
          imgElement.src = 'gfx/cs460.png';
          imgElement.onload = function() {


          }
      }

      function addTransformation() {
        if(isCanvasBlank(document.getElementById('outputCanvas'))) {
            document.getElementById('srcErr').innerHTML = 'Can not copy blank canvas.';
            return;
        }
          document.getElementById('srcErr').innerHTML = '';

          var table = document.getElementById("imageTable");
          var row = table.insertRow(0);
          var cell1 = row.insertCell(0);
          var cell2 = row.insertCell(1);
          let mat1 = cv.imread(document.getElementById('srcImage'));
          let mat2 = cv.imread(document.getElementById('outputCanvas'));

          cell1.innerHTML = '<canvas id="newCanvas1"><canvas>'
          cell2.innerHTML = '<canvas id="newCanvas2"><canvas>'
          cv.imshow('newCanvas1', mat1);
          cv.imshow('newCanvas2', mat2);
          cv.imshow('srcImage'.src, mat2);


          mat1.delete();
          mat2.delete();
      }
      function isCanvasBlank(canvas) {
          const context = canvas.getContext('2d');

          const pixelBuffer = new Uint32Array(
              context.getImageData(0, 0, canvas.width, canvas.height).data.buffer
          );

          return !pixelBuffer.some(color => color !== 0);
      }

  </script>

</html>
